<!-- 
====================================
NPC í”„ë¡œí•„ ì»´í¬ë„ŒíŠ¸ í…œí”Œë¦¿
====================================
ìƒì„±ëœ NPCë“¤ì„ í‘œì‹œí•˜ê³  ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.

ëª¨ë“œë³„ êµ¬ì„±:
1. ì»´íŒ©íŠ¸ ëª¨ë“œ (compactMode=true): NPC ìƒì„± ë‹¨ê³„ì—ì„œ ì‚¬ìš©
   - ê·¸ë¦¬ë“œ í˜•íƒœì˜ ì¹´ë“œ ë ˆì´ì•„ì›ƒ
   - í•„í„°ë§ ë° ê²€ìƒ‰ ê¸°ëŠ¥
   - ìƒì„¸ ì •ë³´ ëª¨ë‹¬
   
2. ìƒì„¸ ëª¨ë“œ (compactMode=false): ìƒí˜¸ì‘ìš© ë‹¨ê³„ì—ì„œ ì‚¬ìš©
   - ëŒ€í˜• ì´ë¯¸ì§€ì™€ í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ì •ë³´
   - ìƒì‚°í’ˆ ê´€ë¦¬ ê¸°ëŠ¥
   - ì¸ë¼ì¸ í™•ì¥/ì¶•ì†Œ

ì£¼ìš” ê¸°ëŠ¥:
- ì—­í• ë³„ í•„í„°ë§
- ì´ë¦„/ì„¤ëª… ê²€ìƒ‰
- ì´ë¯¸ì§€ ë¡œë”© ê´€ë¦¬
- ìƒì‚°í’ˆ ìë™ ìƒì„±
- ëª¨ë‹¬ ê¸°ë°˜ ìƒì„¸ ë³´ê¸°
-->

<div class="npc-profiles-container">
  <!-- ==================== ë¹ˆ ìƒíƒœ (NPC ì—†ìŒ) ==================== -->
  <!-- NPCê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ì„ ë•Œ í‘œì‹œë˜ëŠ” ì•ˆë‚´ ë©”ì‹œì§€ -->
  <div *ngIf="npcProfiles.length === 0" class="empty-state">
    <h3>NPCê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
    <p>ë¨¼ì € ê²Œì„ ì„¸ê³„ê´€ì„ ìƒì„±í•˜ê³  NPCë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
  </div>

  <!-- ==================== ì»´íŒ©íŠ¸ ëª¨ë“œ (NPC ìƒì„± ë‹¨ê³„) ==================== -->
  <!-- ê·¸ë¦¬ë“œ í˜•íƒœì˜ ì¹´ë“œ ë ˆì´ì•„ì›ƒìœ¼ë¡œ NPC ëª©ë¡ì„ í‘œì‹œ -->
  <div *ngIf="npcProfiles.length > 0 && compactMode" class="npc-dashboard">
    
    <!-- ==================== ëŒ€ì‹œë³´ë“œ í—¤ë” (í•„í„° ë° í†µê³„) ==================== -->
    <div class="dashboard-header">
      <!-- í•„í„°ë§ ì„¹ì…˜ -->
      <div class="filter-section">
        <h3>ğŸ‘¥ ìƒì„±ëœ ìºë¦­í„°</h3>
        <div class="filter-controls">
          <!-- ì´ë¦„/ì„¤ëª… ê²€ìƒ‰ ì…ë ¥ì°½ -->
          <div class="search-bar">
            <input 
              type="text" 
              placeholder="ìºë¦­í„° ê²€ìƒ‰..." 
              [(ngModel)]="searchTerm"
              class="search-input">
            <span class="search-icon">ğŸ”</span>
          </div>
          
          <!-- ì—­í• ë³„ í•„í„° ë²„íŠ¼ë“¤ -->
          <div class="role-filters">
            <button 
              *ngFor="let role of availableRoles" 
              class="role-filter-btn"
              [class.active]="selectedRole === role"
              (click)="onRoleFilterChange(role)">
              <!-- ì „ì²´ê°€ ì•„ë‹Œ ì—­í• ì—ë§Œ ì•„ì´ì½˜ í‘œì‹œ -->
              <span *ngIf="role !== 'ì „ì²´'">{{ getRoleIcon(role) }}</span>
              {{ role }}
            </button>
          </div>
        </div>
      </div>
      
      <!-- í†µê³„ ë° ì•¡ì…˜ ì„¹ì…˜ -->
      <div class="stats-and-actions">
        <!-- í†µê³„ ì •ë³´ ì¹´ë“œë“¤ -->
        <div class="stats-section">
          <!-- í•„í„°ë§ëœ ìºë¦­í„° ìˆ˜ -->
          <div class="stat-card">
            <span class="stat-number">{{ filteredNPCs.length }}</span>
            <span class="stat-label">ìºë¦­í„°</span>
          </div>
          <!-- ì‚¬ìš© ê°€ëŠ¥í•œ ì—­í•  ìˆ˜ -->
          <div class="stat-card">
            <span class="stat-number">{{ availableRoles.length - 1 }}</span>
            <span class="stat-label">ì—­í• </span>
          </div>
          <!-- ì´ë¯¸ì§€ ë³´ìœ  ìºë¦­í„° ìˆ˜ -->
          <div class="stat-card">
            <span class="stat-number">{{ getCharactersWithImages() }}</span>
            <span class="stat-label">ì´ë¯¸ì§€ ë³´ìœ </span>
          </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ ì„¹ì…˜ -->
        <div class="action-section">
          <!-- ì „ì²´ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ -->
          <button 
            class="action-btn generate-all-btn"
            [class.generating]="isGeneratingImages"
            [disabled]="isGeneratingImages || getCharactersWithoutImages() === 0"
            (click)="onGenerateAllImages()"
            title="ì´ë¯¸ì§€ê°€ ì—†ëŠ” ëª¨ë“  ìºë¦­í„°ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤">
            <span class="btn-icon" *ngIf="!isGeneratingImages">ğŸ¨</span>
            <div class="btn-spinner" *ngIf="isGeneratingImages">
              <div class="loading-spinner small"></div>
            </div>
            <span class="btn-text">
              {{ isGeneratingImages ? 'ìƒì„± ì¤‘...' : 'ì „ì²´ ì´ë¯¸ì§€ ìƒì„±' }}
            </span>
            <span class="btn-count" *ngIf="!isGeneratingImages && getCharactersWithoutImages() > 0">
              ({{ getCharactersWithoutImages() }}ê°œ)
            </span>
          </button>

          <!-- ìºë¦­í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
          <button 
            class="action-btn refresh-btn"
            (click)="onRefreshCharacters()"
            title="ìºë¦­í„° ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤">
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">ìƒˆë¡œê³ ì¹¨</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ==================== ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸  ==================== -->
    <div class="dashboard-main">
      <!-- NPC ì¹´ë“œ ê·¸ë¦¬ë“œ ì„¹ì…˜ -->
      <div class="npc-grid-section">
        <div class="npc-cards-grid">
          <!-- ê°œë³„ NPC ì¹´ë“œ (í•„í„°ë§ëœ ëª©ë¡) -->
          <div 
            *ngFor="let npc of filteredNPCs; trackBy: trackByNPCId" 
            class="npc-grid-card"
            [class.selected]="isSelectedForDetails(npc)"
            (click)="selectNPCForDetails(npc)">
            
            <!-- NPC ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ -->
            <div class="card-image-container">
              <!-- ì‹¤ì œ NPC ì´ë¯¸ì§€ -->
              <img 
                *ngIf="npc.imageUrl" 
                [src]="npc.imageUrl" 
                [alt]="npc.name"
                class="card-image">
              <!-- ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ í”Œë ˆì´ìŠ¤í™€ë” -->
              <div 
                *ngIf="!npc.imageUrl" 
                class="card-placeholder">
                {{ getRoleIcon(npc.role) }}
                <!-- ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ (ìƒì„± ì¤‘ì´ ì•„ë‹ ë•Œ) -->
                <button 
                  *ngIf="!isGeneratingImage(npc.id)"
                  class="generate-image-btn"
                  (click)="$event.stopPropagation(); onGenerateSingleImage(npc)"
                  title="ì´ë¯¸ì§€ ìƒì„±">
                  ğŸ¨
                </button>
                <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ ìŠ¤í”¼ë„ˆ -->
                <div 
                  *ngIf="isGeneratingImage(npc.id)"
                  class="generating-image-spinner"
                  title="ì´ë¯¸ì§€ ìƒì„± ì¤‘...">
                  <div class="loading-spinner"></div>
                </div>
              </div>
              
              <!-- ì—­í•  ë°°ì§€ (ìš°ìƒë‹¨) -->
              <div class="role-badge" [style.background-color]="getRoleColor(npc.role)">
                {{ getRoleIcon(npc.role) }}
              </div>
            </div>
            
            <!-- NPC ê¸°ë³¸ ì •ë³´ -->
            <div class="card-info">
              <h4 class="card-name">{{ npc.name }}</h4>
              <span class="card-role">{{ npc.role }}</span>
            </div>
          </div>
        </div>
        
        <!-- ==================== ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ ==================== -->
        <div *ngIf="filteredNPCs.length === 0" class="no-results">
          <div class="no-results-content">
            <span class="no-results-icon">ğŸ˜”</span>
            <h4>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== ìƒì„¸ ëª¨ë“œ (ìƒí˜¸ì‘ìš© ë‹¨ê³„) ==================== -->
  <!-- ëŒ€í˜• ì´ë¯¸ì§€ì™€ í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ë ˆì´ì•„ì›ƒ -->
  <div *ngIf="npcProfiles.length > 0 && !compactMode" class="npc-grid">
    <div *ngFor="let npc of npcProfiles" 
         class="npc-card fantasy-card"
         [class.expanded]="isNPCExpanded(npc.id)">
      
      <!-- ==================== NPC ëŒ€í˜• ì´ë¯¸ì§€ ì„¹ì…˜ ==================== -->
      <div class="npc-large-image-container">
        <div class="image-wrapper">
          <!-- ë©”ì¸ NPC ì´ë¯¸ì§€ -->
          <img 
            *ngIf="npc.imageUrl && !isImageLoading(npc.id)" 
            [src]="npc.imageUrl" 
            [alt]="npc.name"
            class="npc-large-image"
            (load)="onImageLoad(npc.id)"
            (error)="onImageError(npc.id)">
          
          <!-- ì´ë¯¸ì§€ êµì²´ ì‹œ ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•œ í”„ë¦¬ë¡œë”© ì´ë¯¸ì§€ -->
          <img 
            *ngIf="getPreloadImageUrl(npc.id)" 
            [src]="getPreloadImageUrl(npc.id)" 
            [alt]="npc.name"
            class="npc-large-image preload-image"
            [class.fade-in]="isPreloadImageReady(npc.id)"
            (load)="onPreloadImageReady(npc.id)"
            (error)="onPreloadImageError(npc.id)">
          
          <!-- ì´ë¯¸ì§€ í”Œë ˆì´ìŠ¤í™€ë” (ë¡œë”© ì¤‘ ë˜ëŠ” ì´ë¯¸ì§€ ì—†ìŒ) -->
          <div *ngIf="!npc.imageUrl || isImageLoading(npc.id)" class="large-placeholder-avatar">
            <div class="placeholder-icon">{{ getRoleIcon(npc.role) }}</div>
            <!-- ì´ë¯¸ì§€ ë¡œë”© ìŠ¤í”¼ë„ˆ -->
            <div class="loading-overlay" *ngIf="isImageLoading(npc.id)">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <!-- ==================== NPC ì •ë³´ ì˜¤ë²„ë ˆì´ ==================== -->
        <!-- ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œë˜ëŠ” ê¸°ë³¸ ì •ë³´ì™€ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="npc-info-overlay">
          <h4 class="npc-name">{{ npc.name }}</h4>
          <span class="npc-role" [style.color]="getRoleColor(npc.role)">
            {{ getRoleIcon(npc.role) }} {{ npc.role }}
          </span>
          
          <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
          <div class="npc-actions">
            <!-- ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ (ì´ë¯¸ì§€ê°€ ì—†ê³  ìƒì„± ì¤‘ì´ ì•„ë‹ ë•Œ) -->
            <button *ngIf="!npc.imageUrl && !isGeneratingImage(npc.id)"
                    class="action-button generate-button" 
                    (click)="onGenerateSingleImage(npc)"
                    title="ì´ë¯¸ì§€ ìƒì„±">
              ğŸ¨
            </button>
            <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ í‘œì‹œ -->
            <div *ngIf="!npc.imageUrl && isGeneratingImage(npc.id)"
                 class="action-button generating"
                 title="ì´ë¯¸ì§€ ìƒì„± ì¤‘...">
              <div class="loading-spinner small"></div>
            </div>
            <!-- ëŒ€í™”í•˜ê¸° ë²„íŠ¼ -->
            <button class="action-button chat-button" 
                    (click)="onSelectNPC(npc)"
                    title="ëŒ€í™”í•˜ê¸°">
              ğŸ’¬
            </button>
            <!-- ìƒì„¸ ì •ë³´ í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ -->
            <button class="action-button expand-button" 
                    (click)="toggleNPCExpansion(npc.id)"
                    [class.expanded]="isNPCExpanded(npc.id)"
                    title="ìì„¸íˆ ë³´ê¸°">
              {{ isNPCExpanded(npc.id) ? 'ğŸ”¼' : 'ğŸ”½' }}
            </button>
          </div>
        </div>
      </div>

      <!-- ==================== NPC ê¸°ë³¸ ì„¤ëª… ==================== -->
      <div class="npc-description">
        <p>{{ npc.description }}</p>
      </div>

      <!-- ==================== í™•ì¥ëœ ìƒì„¸ ì •ë³´ ==================== -->
      <!-- NPC ìƒì„¸ ì •ë³´ì™€ ìƒì‚°í’ˆì„ í‘œì‹œí•˜ëŠ” ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ -->
      <div *ngIf="isNPCExpanded(npc.id)" class="npc-details-container">
        <div class="npc-details-scroll">
          <!-- NPC ë°°ê²½ -->
          <div class="detail-section">
            <h5>ğŸ“– ë°°ê²½</h5>
            <p>{{ npc.background }}</p>
          </div>

          <!-- NPC ì„±ê²© -->
          <div class="detail-section">
            <h5>ğŸ­ ì„±ê²©</h5>
            <p>{{ npc.personality }}</p>
          </div>

          <!-- NPC ì™¸ëª¨ -->
          <div class="detail-section">
            <h5>ğŸ‘¤ ì™¸ëª¨</h5>
            <p>{{ npc.appearance }}</p>
          </div>

          <!-- ==================== NPC ìƒì‚°í’ˆ ì„¹ì…˜ ==================== -->
          <div class="products-section">
            <h5>{{ getProductsTitle(npc) }}</h5>
            
            <!-- ìƒì‚°í’ˆ ë¡œë”© ìƒíƒœ -->
            <div *ngIf="isLoadingProducts(npc.id)" class="loading-products">
              <div class="loading-spinner"></div>
              <span>ìƒì‚°í’ˆ ìƒì„± ì¤‘...</span>
            </div>

            <!-- ë¬´ê¸° ì„¹ì…˜ (ëŒ€ì¥ì¥ì´ ë“±) -->
            <div *ngIf="hasWeapons(npc)" class="weapons-section">
              <h6>âš”ï¸ ì œì‘ëœ ë¬´ê¸°</h6>
              <app-weapon-viewer 
                *ngFor="let weapon of getWeapons(npc)" 
                [weapon]="weapon">
              </app-weapon-viewer>
            </div>

            <!-- í€˜ìŠ¤íŠ¸ (ëª¨ë“  NPC ê°€ëŠ¥) -->
            <div *ngIf="hasQuests(npc)" class="quests-section">
              <h6>ğŸ“‹ ì œê³µ ê°€ëŠ¥í•œ í€˜ìŠ¤íŠ¸</h6>
              <app-quest-viewer 
                *ngFor="let quest of getQuests(npc)" 
                [quest]="quest">
              </app-quest-viewer>
            </div>

            <!-- ë§ˆë²• (ë§ˆë²•ì‚¬ ë“±) -->
            <div *ngIf="hasMagic(npc)" class="magic-section">
              <h6>ğŸ”® ì—°êµ¬í•œ ë§ˆë²•</h6>
              <app-magic-viewer 
                *ngFor="let magic of getMagic(npc)" 
                [magic]="magic">
              </app-magic-viewer>
            </div>

            <!-- ì¼ë°˜ ì•„ì´í…œ (ìƒì¸ ë“±) -->
            <div *ngIf="hasItems(npc)" class="items-section">
              <h6>ğŸ“¦ ë³´ìœ í•œ ì•„ì´í…œ</h6>
              <div *ngFor="let item of getItems(npc)" class="item-card">
                <div class="item-name">{{ item.name }}</div>
                <p>{{ item.description }}</p>
              </div>
            </div>

            <!-- ìƒì‚°í’ˆì´ ì—†ëŠ” ê²½ìš° -->
            <div *ngIf="!isLoadingProducts(npc.id) && (!npc.products || npc.products.length === 0)" 
                 class="no-products">
              <p>ì•„ì§ ìƒì‚°í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
              <button class="fantasy-button" (click)="generateNPCProducts(npc)">
                ìƒì‚°í’ˆ ìƒì„±í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== NPC ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ==================== -->
  <!-- ì»´íŒ©íŠ¸ ëª¨ë“œì—ì„œ NPC í´ë¦­ ì‹œ í‘œì‹œë˜ëŠ” ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div *ngIf="isModalOpen && modalNPC" class="npc-modal-overlay" (click)="onModalBackgroundClick($event)">
    <div class="npc-modal-container">
      <!-- ==================== ëª¨ë‹¬ í—¤ë” ==================== -->
      <div class="modal-header">
        <h2 class="modal-title">{{ modalNPC.name }}</h2>
        <!-- ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ -->
        <button class="modal-close-btn" (click)="closeNPCModal()">âœ•</button>
      </div>

      <!-- ==================== ëª¨ë‹¬ ë©”ì¸ ì½˜í…ì¸  ==================== -->
      <div class="modal-content">
        <!-- ì¢Œì¸¡: NPC ì´ë¯¸ì§€ ì„¹ì…˜ -->
        <div class="modal-image-section">
          <!-- NPC ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ -->
          <div class="modal-image-container">
            <img 
              *ngIf="modalNPC.imageUrl" 
              [src]="modalNPC.imageUrl" 
              [alt]="modalNPC.name"
              class="modal-image">
            <!-- ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ í”Œë ˆì´ìŠ¤í™€ë” -->
            <div 
              *ngIf="!modalNPC.imageUrl" 
              class="modal-placeholder">
              {{ getRoleIcon(modalNPC.role) }}
              <!-- ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ (ìƒì„± ì¤‘ì´ ì•„ë‹ ë•Œ) -->
              <button 
                *ngIf="!isGeneratingImage(modalNPC.id)"
                class="modal-generate-image-btn"
                (click)="onGenerateSingleImage(modalNPC)"
                title="ì´ë¯¸ì§€ ìƒì„±">
                ğŸ¨ ì´ë¯¸ì§€ ìƒì„±
              </button>
              <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ ìŠ¤í”¼ë„ˆ -->
              <div 
                *ngIf="isGeneratingImage(modalNPC.id)"
                class="modal-generating-image"
                title="ì´ë¯¸ì§€ ìƒì„± ì¤‘...">
                <div class="loading-spinner"></div>
                <span>ìƒì„± ì¤‘...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ìš°ì¸¡: íƒ­ ê¸°ë°˜ ìƒì„¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="modal-details-section">
          <!-- ==================== íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ==================== -->
          <div class="modal-tabs">
            <!-- ìºë¦­í„° ì •ë³´ íƒ­ -->
            <button 
              class="modal-tab-btn"
              [class.active]="isActiveTab('character')"
              (click)="setActiveTab('character')">
              ğŸ‘¤ ìºë¦­í„° ì •ë³´
            </button>
            <!-- ìƒì‚°í’ˆ íƒ­ -->
            <button 
              class="modal-tab-btn"
              [class.active]="isActiveTab('products')"
              (click)="setActiveTab('products')">
              ğŸ›¡ï¸ ìƒì‚°í’ˆ
            </button>
          </div>

          <!-- ==================== íƒ­ ì½˜í…ì¸  ì˜ì—­ ==================== -->
          <div class="modal-tab-content">
            
            <!-- ==================== ìºë¦­í„° ì •ë³´ íƒ­ íŒ¨ë„ ==================== -->
            <div *ngIf="isActiveTab('character')" class="modal-tab-panel character-panel">
              <div class="character-details">
                <!-- NPC ê¸°ë³¸ ì •ë³´ -->
                <div class="detail-section">
                  <h5>ğŸ“ ê¸°ë³¸ ì •ë³´</h5>
                  <div class="basic-info-grid">
                    <div class="info-item">
                      <strong>ì´ë¦„:</strong> {{ modalNPC.name }}
                    </div>
                    <div class="info-item">
                      <strong>ì—­í• :</strong> 
                      <span [style.color]="getRoleColor(modalNPC.role)">
                        {{ getRoleIcon(modalNPC.role) }} {{ modalNPC.role }}
                      </span>
                    </div>
                  </div>
                  <p class="basic-description">{{ modalNPC.description }}</p>
                </div>

                <!-- NPC ë°°ê²½ -->
                <div class="detail-section">
                  <h5>ğŸ“– ë°°ê²½</h5>
                  <p>{{ modalNPC.background }}</p>
                </div>

                <!-- NPC ì„±ê²© -->
                <div class="detail-section">
                  <h5>ğŸ­ ì„±ê²©</h5>
                  <p>{{ modalNPC.personality }}</p>
                </div>

                <!-- NPC ì™¸ëª¨ -->
                <div class="detail-section">
                  <h5>ğŸ‘¤ ì™¸ëª¨</h5>
                  <p>{{ modalNPC.appearance }}</p>
                </div>
              </div>
            </div>

            <!-- ==================== ìƒì‚°í’ˆ íƒ­ íŒ¨ë„ ==================== -->
            <div *ngIf="isActiveTab('products')" class="modal-tab-panel products-panel">
              <div class="products-content">
                <h5 class="products-title">{{ getProductsTitle(modalNPC) }}</h5>
                
                <!-- ìƒì‚°í’ˆ ë¡œë”© ìƒíƒœ -->
                <div *ngIf="isLoadingProducts(modalNPC.id)" class="loading-products">
                  <div class="loading-spinner"></div>
                  <span>ìƒì‚°í’ˆ ìƒì„± ì¤‘...</span>
                </div>

                <!-- ë¬´ê¸° í•˜ìœ„ ì„¹ì…˜ -->
                <div *ngIf="hasWeapons(modalNPC)" class="products-subsection">
                  <h6>âš”ï¸ ì œì‘ëœ ë¬´ê¸°</h6>
                  <app-weapon-viewer 
                    *ngFor="let weapon of getWeapons(modalNPC)" 
                    [weapon]="weapon">
                  </app-weapon-viewer>
                </div>

                <!-- í€˜ìŠ¤íŠ¸ í•˜ìœ„ ì„¹ì…˜ -->
                <div *ngIf="hasQuests(modalNPC)" class="products-subsection">
                  <h6>ğŸ“‹ ì œê³µ ê°€ëŠ¥í•œ í€˜ìŠ¤íŠ¸</h6>
                  <app-quest-viewer 
                    *ngFor="let quest of getQuests(modalNPC)" 
                    [quest]="quest">
                  </app-quest-viewer>
                </div>

                <!-- ë§ˆë²• í•˜ìœ„ ì„¹ì…˜ -->
                <div *ngIf="hasMagic(modalNPC)" class="products-subsection">
                  <h6>ğŸ”® ì—°êµ¬í•œ ë§ˆë²•</h6>
                  <app-magic-viewer 
                    *ngFor="let magic of getMagic(modalNPC)" 
                    [magic]="magic">
                  </app-magic-viewer>
                </div>

                <!-- ì¼ë°˜ ì•„ì´í…œ í•˜ìœ„ ì„¹ì…˜ -->
                <div *ngIf="hasItems(modalNPC)" class="products-subsection">
                  <h6>ğŸ“¦ ë³´ìœ í•œ ì•„ì´í…œ</h6>
                  <div *ngFor="let item of getItems(modalNPC)" class="item-card">
                    <div class="item-name">{{ item.name }}</div>
                    <p>{{ item.description }}</p>
                  </div>
                </div>

                <!-- ìƒì‚°í’ˆì´ ì—†ëŠ” ê²½ìš° ìƒì„± ë²„íŠ¼ -->
                <div *ngIf="!isLoadingProducts(modalNPC.id) && (!modalNPC.products || modalNPC.products.length === 0)" 
                     class="no-products">
                  <p>ì•„ì§ ìƒì‚°í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  <button class="fantasy-button" (click)="generateNPCProducts(modalNPC)">
                    ìƒì‚°í’ˆ ìƒì„±í•˜ê¸°
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== ëª¨ë‹¬ í‘¸í„° (ì•¡ì…˜ ë²„íŠ¼ë“¤) ==================== -->
      <div class="modal-footer">
        <!-- ëŒ€í™”í•˜ê¸° ë²„íŠ¼ (ì£¼ìš” ì•¡ì…˜) -->
        <button 
          class="modal-action-btn primary"
          (click)="onSelectNPC(modalNPC); closeNPCModal()">
          ğŸ’¬ ëŒ€í™”í•˜ê¸°
        </button>

        <!-- ==================== ì—­í• ë³„ íŠ¹ë³„ ê¸°ëŠ¥ ë²„íŠ¼ë“¤ ==================== -->
        
        <!-- ëŒ€ì¥ì¥ì´ ë¬´ê¸° ì œì‘ ë²„íŠ¼ -->
        <button 
          *ngIf="isBlacksmith(modalNPC)"
          class="modal-action-btn role-specific blacksmith"
          (click)="onCraftWeapon(modalNPC)"
          title="ë¬´ê¸° ì œì‘ ìš”ì²­">
          âš’ï¸ ë¬´ê¸° ì œì‘
        </button>

        <!-- ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì¸ ì£¼ë¬¸ ì œì‘ ë²„íŠ¼ -->
        <button 
          *ngIf="isMagicScrollMerchant(modalNPC)"
          class="modal-action-btn role-specific magic-merchant"
          (click)="onCraftSpell(modalNPC)"
          title="ì£¼ë¬¸ ì œì‘ ìš”ì²­">
          ğŸ“œ ì£¼ë¬¸ ì œì‘
        </button>

        <!-- ê¸¸ë“œ ë§ˆìŠ¤í„° í€˜ìŠ¤íŠ¸ ì˜ë¢° ë²„íŠ¼ -->
        <button 
          *ngIf="isGuildMaster(modalNPC)"
          class="modal-action-btn role-specific guild-master"
          (click)="onAssignQuest(modalNPC)"
          title="í€˜ìŠ¤íŠ¸ ì˜ë¢° ìš”ì²­">
          ğŸ“‹ í€˜ìŠ¤íŠ¸ ì˜ë¢°
        </button>
        
        <!-- ê°œë³„ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ (ì´ë¯¸ì§€ê°€ ì—†ê³  ìƒì„± ì¤‘ì´ ì•„ë‹ ë•Œ) -->
        <button 
          *ngIf="!modalNPC.imageUrl && !isGeneratingImage(modalNPC.id)"
          class="modal-action-btn secondary"
          (click)="onGenerateSingleImage(modalNPC)">
          ğŸ¨ ì´ë¯¸ì§€ ìƒì„±
        </button>
        <!-- ì´ë¯¸ì§€ ìƒì„± ì¤‘ í‘œì‹œ -->
        <button 
          *ngIf="!modalNPC.imageUrl && isGeneratingImage(modalNPC.id)"
          class="modal-action-btn secondary disabled">
          <div class="loading-spinner small"></div> ìƒì„± ì¤‘...
        </button>
        <!-- ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ -->
        <button 
          class="modal-action-btn tertiary"
          (click)="closeNPCModal()">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== ê°œë³„ NPC ì´ë¯¸ì§€ ìƒì„± Waiting Dialog ==================== -->
  <div *ngIf="currentGeneratingNPC" class="waiting-dialog-overlay">
    <div class="waiting-dialog">
      <div class="waiting-dialog-content">
        <div class="waiting-spinner">
          <div class="loading-spinner large"></div>
        </div>
        <h3>{{ currentGeneratingNPC.name }} ì´ë¯¸ì§€ ìƒì„± ì¤‘...</h3>
        <p>AIê°€ ìºë¦­í„°ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        <p class="waiting-subtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        
        <!-- ìƒì„± ì¤‘ì¸ NPC ì •ë³´ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="generating-npc-preview">
          <div class="preview-role" [style.color]="getRoleColor(currentGeneratingNPC.role)">
            {{ getRoleIcon(currentGeneratingNPC.role) }} {{ currentGeneratingNPC.role }}
          </div>
          <div class="preview-description">{{ currentGeneratingNPC.description }}</div>
        </div>
      </div>
    </div>
  </div>
</div>
